{% doc %}
  @prompt
    Create a full-width announcement bar (black background) with white, bold uppercase text and a live countdown timer at the start. The countdown must start at 10:00:00 and count down to 00:00:00, then automatically reset back to 10:00:00 and continue looping forever.
    
    Layout:
    
    Single line, centered horizontally and vertically
    
    Timer format: HH:MM:SS (include leading zeros)
    
    After the timer, add a space and then this exact text:
    “CLOSURE SALE – EVERYTHING FREE STORE WIDE”
    
    Use a bold font, all caps, with slightly increased letter spacing
    
    Height approx 44–52px, minimal padding
    
    Must be responsive (fits mobile without wrapping; if needed scale font slightly down on small screens)
    
    Technical requirements:
    
    Countdown must run in JavaScript
    
    Persist timer across page reloads using localStorage (so it doesn’t reset when user refreshes)
    
    Reset exactly every 10 hours (36000 seconds)
    
    Ensure multiple instances don’t conflict (unique IDs/scoped script)
    
    Name the section: “Looping Countdown Announcement Bar (10h)”
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-countdown-bar-{{ ai_gen_id }} {
    display: block;
    width: 100%;
    background-color: {{ block.settings.background_color }};
    color: {{ block.settings.text_color }};
    min-height: {{ block.settings.bar_height }}px;
    padding: 0 20px;
  }

  .ai-countdown-bar__content-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: {{ block.settings.bar_height }}px;
    gap: 8px;
    font-size: {{ block.settings.font_size }}px;
    font-weight: {{ block.settings.font_weight }};
    text-transform: uppercase;
    letter-spacing: {{ block.settings.letter_spacing }}px;
    line-height: 1.2;
  }

  .ai-countdown-bar__timer-{{ ai_gen_id }} {
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .ai-countdown-bar__text-{{ ai_gen_id }} {
    white-space: nowrap;
  }

  @media screen and (max-width: 749px) {
    .ai-countdown-bar__content-{{ ai_gen_id }} {
      font-size: {{ block.settings.font_size | times: 0.8 }}px;
      gap: 6px;
      padding: 8px 0;
    }
  }

  @media screen and (max-width: 480px) {
    .ai-countdown-bar__content-{{ ai_gen_id }} {
      font-size: {{ block.settings.font_size | times: 0.7 }}px;
      gap: 4px;
    }
  }
{% endstyle %}

<countdown-announcement-{{ ai_gen_id }}
  class="ai-countdown-bar-{{ ai_gen_id }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-countdown-bar__content-{{ ai_gen_id }}">
    <span class="ai-countdown-bar__timer-{{ ai_gen_id }}" data-timer>10:00:00</span>
    <span class="ai-countdown-bar__text-{{ ai_gen_id }}">{{ block.settings.announcement_text }}</span>
  </div>
</countdown-announcement-{{ ai_gen_id }}>

<script>
  (function() {
    class CountdownAnnouncement{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.timerElement = this.querySelector('[data-timer]');
        this.storageKey = 'countdown_{{ ai_gen_id }}_start';
        this.totalDuration = 36000;
        this.intervalId = null;
      }

      connectedCallback() {
        this.initializeTimer();
        this.startCountdown();
      }

      disconnectedCallback() {
        if (this.intervalId) {
          clearInterval(this.intervalId);
        }
      }

      initializeTimer() {
        const storedStart = localStorage.getItem(this.storageKey);
        const now = Math.floor(Date.now() / 1000);

        if (storedStart) {
          const elapsed = now - parseInt(storedStart, 10);
          if (elapsed >= this.totalDuration) {
            localStorage.setItem(this.storageKey, now.toString());
          }
        } else {
          localStorage.setItem(this.storageKey, now.toString());
        }
      }

      getRemainingSeconds() {
        const storedStart = localStorage.getItem(this.storageKey);
        const now = Math.floor(Date.now() / 1000);
        const elapsed = now - parseInt(storedStart, 10);
        const remaining = this.totalDuration - (elapsed % this.totalDuration);
        return remaining === this.totalDuration ? this.totalDuration : remaining;
      }

      formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        return [hours, minutes, secs]
          .map(val => val.toString().padStart(2, '0'))
          .join(':');
      }

      updateDisplay() {
        const remaining = this.getRemainingSeconds();
        this.timerElement.textContent = this.formatTime(remaining);

        if (remaining === this.totalDuration) {
          const now = Math.floor(Date.now() / 1000);
          localStorage.setItem(this.storageKey, now.toString());
        }
      }

      startCountdown() {
        this.updateDisplay();
        this.intervalId = setInterval(() => {
          this.updateDisplay();
        }, 1000);
      }
    }

    customElements.define('countdown-announcement-{{ ai_gen_id }}', CountdownAnnouncement{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Countdown bar (10h loop)",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "announcement_text",
      "label": "Announcement text",
      "default": "CLOSURE SALE – EVERYTHING FREE STORE WIDE"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "bar_height",
      "min": 40,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Bar height",
      "default": 48
    },
    {
      "type": "range",
      "id": "font_size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "label": "Font size",
      "default": 14
    },
    {
      "type": "select",
      "id": "font_weight",
      "label": "Font weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi bold"
        },
        {
          "value": "700",
          "label": "Bold"
        },
        {
          "value": "800",
          "label": "Extra bold"
        }
      ],
      "default": "700"
    },
    {
      "type": "range",
      "id": "letter_spacing",
      "min": 0,
      "max": 3,
      "step": 0.5,
      "unit": "px",
      "label": "Letter spacing",
      "default": 1
    }
  ],
  "presets": [
    {
      "name": "Countdown bar (10h loop)"
    }
  ]
}
{% endschema %}
