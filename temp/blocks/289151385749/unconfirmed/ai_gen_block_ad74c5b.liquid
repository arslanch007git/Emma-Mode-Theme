{% doc %}
  @prompt
    Create a full-width announcement bar (black background) with white, bold uppercase text and a live countdown timer at the start. The countdown must start at 10:00:00 and count down to 00:00:00, then automatically reset back to 10:00:00 and continue looping forever.
    
    Layout:
    
    Single line, centered horizontally and vertically
    
    Timer format: HH:MM:SS (include leading zeros)
    
    After the timer, add a space and then this exact text:
    “CLOSURE SALE – EVERYTHING FREE STORE WIDE”
    
    Use a bold font, all caps, with slightly increased letter spacing
    
    Height approx 44–52px, minimal padding
    
    Must be responsive (fits mobile without wrapping; if needed scale font slightly down on small screens)
    
    Technical requirements:
    
    Countdown must run in JavaScript
    
    Persist timer across page reloads using localStorage (so it doesn’t reset when user refreshes)
    
    Reset exactly every 10 hours (36000 seconds)
    
    Ensure multiple instances don’t conflict (unique IDs/scoped script)
    
    Name the section: “Looping Countdown Announcement Bar (10h)”
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-countdown-bar-{{ ai_gen_id }} {
    display: block;
    width: 100%;
    background-color: {{ block.settings.background_color }};
    color: {{ block.settings.text_color }};
    min-height: {{ block.settings.bar_height }}px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    font-family: {{ block.settings.font.family }}, {{ block.settings.font.fallback_families }};
    font-weight: {{ block.settings.font.weight }};
    font-style: {{ block.settings.font.style }};
  }

  .ai-countdown-bar__content-{{ ai_gen_id }} {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-align: center;
    width: 100%;
    max-width: 100%;
  }

  .ai-countdown-bar__timer-{{ ai_gen_id }} {
    font-size: {{ block.settings.font_size }}px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: {{ block.settings.letter_spacing }}px;
    white-space: nowrap;
    font-variant-numeric: tabular-nums;
  }

  .ai-countdown-bar__text-{{ ai_gen_id }} {
    font-size: {{ block.settings.font_size }}px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: {{ block.settings.letter_spacing }}px;
  }

  @media screen and (max-width: 749px) {
    .ai-countdown-bar-{{ ai_gen_id }} {
      padding: 10px 16px;
    }

    .ai-countdown-bar__timer-{{ ai_gen_id }},
    .ai-countdown-bar__text-{{ ai_gen_id }} {
      font-size: {{ block.settings.font_size | times: 0.85 }}px;
    }

    .ai-countdown-bar__content-{{ ai_gen_id }} {
      gap: 6px;
    }
  }

  @media screen and (max-width: 480px) {
    .ai-countdown-bar__timer-{{ ai_gen_id }},
    .ai-countdown-bar__text-{{ ai_gen_id }} {
      font-size: {{ block.settings.font_size | times: 0.75 }}px;
    }

    .ai-countdown-bar__content-{{ ai_gen_id }} {
      gap: 4px;
    }
  }
{% endstyle %}

<countdown-announcement-bar-{{ ai_gen_id }}
  class="ai-countdown-bar-{{ ai_gen_id }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-countdown-bar__content-{{ ai_gen_id }}">
    <span class="ai-countdown-bar__timer-{{ ai_gen_id }}" id="ai-countdown-timer-{{ ai_gen_id }}">10:00:00</span>
    <span class="ai-countdown-bar__text-{{ ai_gen_id }}">{{ block.settings.announcement_text }}</span>
  </div>
</countdown-announcement-bar-{{ ai_gen_id }}>

<script>
  (function() {
    class CountdownAnnouncementBar{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.storageKey = 'ai_countdown_{{ ai_gen_id }}_start';
        this.totalDuration = 36000;
        this.timerElement = null;
        this.intervalId = null;
      }

      connectedCallback() {
        this.timerElement = this.querySelector('#ai-countdown-timer-{{ ai_gen_id }}');
        this.initializeTimer();
        this.startCountdown();
      }

      disconnectedCallback() {
        if (this.intervalId) {
          clearInterval(this.intervalId);
        }
      }

      initializeTimer() {
        try {
          const storedStart = localStorage.getItem(this.storageKey);
          const now = Math.floor(Date.now() / 1000);

          if (storedStart) {
            const startTime = parseInt(storedStart, 10);
            const elapsed = now - startTime;

            if (elapsed >= this.totalDuration) {
              const cycles = Math.floor(elapsed / this.totalDuration);
              const newStart = startTime + (cycles * this.totalDuration);
              localStorage.setItem(this.storageKey, newStart.toString());
            }
          } else {
            localStorage.setItem(this.storageKey, now.toString());
          }
        } catch (e) {
          console.warn('localStorage not available, timer will reset on page reload');
        }
      }

      getTimeRemaining() {
        try {
          const storedStart = localStorage.getItem(this.storageKey);
          if (!storedStart) {
            return this.totalDuration;
          }

          const startTime = parseInt(storedStart, 10);
          const now = Math.floor(Date.now() / 1000);
          const elapsed = now - startTime;
          const remaining = this.totalDuration - (elapsed % this.totalDuration);

          return remaining;
        } catch (e) {
          return this.totalDuration;
        }
      }

      formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;

        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }

      updateDisplay() {
        const remaining = this.getTimeRemaining();
        if (this.timerElement) {
          this.timerElement.textContent = this.formatTime(remaining);
        }
      }

      startCountdown() {
        this.updateDisplay();

        this.intervalId = setInterval(() => {
          this.updateDisplay();
        }, 1000);
      }
    }

    customElements.define('countdown-announcement-bar-{{ ai_gen_id }}', CountdownAnnouncementBar{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Countdown announcement",
  "tag": null,
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "announcement_text",
      "label": "Announcement text",
      "default": "CLOSURE SALE – EVERYTHING FREE STORE WIDE"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "font_picker",
      "id": "font",
      "label": "Font",
      "default": "sans-serif"
    },
    {
      "type": "range",
      "id": "font_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Font size",
      "default": 14
    },
    {
      "type": "range",
      "id": "letter_spacing",
      "min": 0,
      "max": 3,
      "step": 0.5,
      "unit": "px",
      "label": "Letter spacing",
      "default": 1
    },
    {
      "type": "range",
      "id": "bar_height",
      "min": 40,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Bar height",
      "default": 48
    }
  ],
  "presets": [
    {
      "name": "Countdown announcement"
    }
  ]
}
{% endschema %}
